/* Thinfinity(c) Remote Desktop Server v7.0.3.114 */
Object.defineProperty(window,"productId",{"enumarable":true,"configurable":false,"get":function(){return"WebVPN"}});Object.defineProperty(window,"cookiePrefix",{"enumarable":true,"configurable":false,"get":function(){return"WVPN"}});Object.defineProperty(window,"fromBroker",{"enumarable":true,"configurable":false,"get":function(){return true}});Object.defineProperty(window,"productName",{"enumerable":true,"configurable":false,"get":function(){return"Thinfinity Remote Workspace"}});
(function(){var _binding=[{"base":"common","propName":"defaultSettings","scraper":false,"search":"customSettings"},{"base":"settings","propName":"customSettings","scraper":true},{"base":"editorSettings","propName":"customProfileDefaults","scraper":true}];var _warn=console.warn||console.log;function initialize(){if(window.cookiePrefix)_binding.forEach(function(item){if(window.userSettings&&(userSettings[window.cookiePrefix]&&userSettings[window.cookiePrefix][item.propName]||userSettings[item.base]&&
userSettings[item.base][item.search])){_warn("Loading settings ["+item.base+"] from deprecated customSettings instead of web.settings.");var _get=userSettings[window.cookiePrefix]&&userSettings[window.cookiePrefix][item.propName]?userSettings[window.cookiePrefix][item.propName]:userSettings[item.base][item.search];if(!window[item.propName])Object.defineProperty(window,item.propName,{"enumerable":true,"configurable":false,"get":function(){return _get}});else _warn("Cannot create web settings, ["+_definePropertyName+
"] property is already defined")}else if(window[item.base])if(item.scraper)if(window[item.base][window.cookiePrefix])if(!window[item.propName])Object.defineProperty(window,item.propName,{"enumerable":true,"configurable":false,"get":function(){return window[item.base][window.cookiePrefix]}});else _warn("Cannot create web settings, ["+_definePropertyName+"] property is already defined");else _warn(JSON.stringify(window[item.base])+" definitions is empty for this scraper ["+window.cookiePrefix+"], please complete the requested info.");
else{if(!window[item.propName])Object.defineProperty(window,item.propName,{"enumerable":true,"configurable":false,"get":function(){return window[item.base]}})}else _warn(item.base+" is not defined, please check web.settings file in DB folder")});else _warn("cookiePrefix is not defined");window.addEventListener("load",function(){if(typeof customSettings!="undefined")Object.defineProperty(customSettings,"defaultValues",{"enumerable":true,"configurable":false,"get":function(){return{"mobile":{"gestures":Thinfinity&&
Thinfinity.Mobile?Thinfinity.Mobile.defaultTouchGestures:[]}}}})})}initialize()})();
(function(){function ServiceWorkerVariables(){var _ref=this;var _publicVariables={};function initialize(){var postdata=document.querySelectorAll('meta[name="thinfinity-postdata"]');for(var i=0,len=postdata.length;i<len;i++)try{var name=postdata[i].getAttribute("data-name");var value=postdata[i].getAttribute("data-value");_publicVariables[name]=value;var type=postdata[i].getAttribute("data-type")||"json";if(type==="json")try{if(value.substring(0)==="("&&value.substring(value.length-1)===")")value=
value.substring(1,value.length-1);_publicVariables[name]=JSON.parse(value)}catch(error){console.log("error parsing JSON ("+name+"): "+error.message)}document.head.removeChild(postdata[i])}catch(error){console.log(error.message)}}initialize();Object.defineProperty(Thinfinity.Service,"variables",{"enumerable":true,"configurable":false,"get":function(){return _publicVariables}});return _ref}try{Thinfinity!==undefined}catch(e){Thinfinity={}}if(Thinfinity.Service===undefined)Thinfinity.Service={};ServiceWorkerVariables()})();
(function(){function Identification(args){let prefix=args?.prefix??null;let useLPN=args?.autoPrefix??!args?.prefix??true;if(useLPN)prefix=btoa(location.pathname);if(!(prefix&&prefix!=""))throw new Error(`Cannot initialize Thinfinity.Identification, prefix is null or undefined;`);const _ssKey=`__#thinfinity.identification.${prefix}.__`;let _ref={};let _availableStorages=[window.sessionStorage,window.localStorage];const getTabName=()=>{let name=null,idx=0,len=_availableStorages.length;while(!name&&
idx<len){name=getNameFrom(_availableStorages[idx]);idx++}if(!name)name=setName();return name};let getNameFrom=storage=>{let name=null;let data=storage.getItem(_ssKey);if(data)try{data=JSON.parse(data);name=data.name}catch(error){}return name};const setName=()=>{let mask=useLPN?`thin.tabid-xxx-${prefix}`:`thin.${prefix}-xxx-xxx-xxx-xxx`;let name=mask.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)});let w=false,idx=0,len=_availableStorages.length;while(!w&&
idx<len)try{_availableStorages[idx].setItem(_ssKey,JSON.stringify({name}));w=true}catch(err){console.log(`Cannot write storage: ${err.message}`)}return name};const remove=()=>{let idx=0,len=_availableStorages.length;while(idx<len){_availableStorages[idx].removeItem(_ssKey);idx++}};const _name=getTabName();Object.defineProperty(_ref,"name",{enumerable:true,configurable:false,get:function(){return _name}});Object.defineProperty(_ref,"remove",{enumerable:true,configurable:false,writable:false,value:remove});
return _ref}try{Thinfinity!==undefined}catch(e){Thinfinity={}}Thinfinity.Identification=Identification})();(function(){if(Thinfinity.Identification){if(typeof Thinfinity.WAG==="undefined")Thinfinity.WAG={};Thinfinity.WAG.Identification=prefix=>{return new Thinfinity.Identification({prefix})}}else throw new Error(`Thinfinity.Identification is not defined`);})();
(function(){const _swstate={"installing":0,"installed":1,"activating":2,"activated":3,"redundant":4};if(Object.freeze)Object.freeze(_swstate);function ServiceWorkerRegistrator(){var _ref=this;var _isAvailable=false;var _notSupportedMsg="Service Workers are not supported by your browser.";var _notSupportedHandler=function(){return _notSupportedMsg};var _notSupportedPromise=function(){return new Promise((resolve,reject)=>{reject(_notSupportedMsg)})};let _controller=null;function initialize(){if("serviceWorker"in
window.navigator)_isAvailable=true;else console.warn(`Service Worker is not available in your browser. "serviceWorker" is not in window.navigator object.`)}function initializeNewService(workerUrl,options){return new Promise(function(resolve,reject){if(options===undefined)options={};window.navigator.serviceWorker.register(workerUrl,options).then(()=>{getInstalledService(options.scope).then(resolve).catch(reject)}).catch(function(error){console.warn("Service worker registration failed:",error);_notSupportedMsg=
error;reject(error)})})}function unregisterService(clientURL,matchCase){return new Promise((resolve,reject)=>{clientURL=normalizeScope(clientURL);getInstalledService(clientURL).then(result=>{if(result&&result.unregister)result.unregister().then(resolve).catch(reject);else if(matchCase===false)unregisterServiceUnMatchCase(clientURL).then(resolve).catch(reject)}).catch(reject)})}function unregisterServiceUnMatchCase(clientURL){return new Promise((resolve,reject)=>{navigator.serviceWorker.getRegistrations().then(registrations=>
{if(registrations){clientURL=clientURL.toLowerCase();let proms=[];registrations.forEach(reg=>{let scope=reg.scope.replace(location.origin,"");if(scope.toLowerCase()===clientURL)proms.push(reg.unregister())});Promise.all(proms).then(resolve).catch(reject)}})})}function normalizeScope(scope){if(scope){if(scope==="/")return scope;let scopes=scope.split("/").filter(s=>s!=="");if(scopes.length==1)return`/${scopes[0]}/`;else return null}else return null}function getInstalledService(clientURL){return new Promise(function(resolve,
reject){if(clientURL!=="")navigator.serviceWorker.getRegistration(clientURL).then(resolve).catch(reject);else reject("Invalid clientURL")})}function getController(){return new Promise((resolve,reject)=>{if(navigator.serviceWorker.controller)resolve(navigator.serviceWorker.controller);else{console.warn(`Controller is not running, please wait...`);let timeoutId=null;timeoutId=setTimeout(()=>{reject(`ServiceWorker is not controlling the page..., trying to reload...`)},45E3);navigator.serviceWorker.ready.then(e=>
{clearTimeout(timeoutId);resolve(navigator.serviceWorker.controller)}).catch(err=>{clearTimeout(timeoutId);reject(null)})}})}function sendMessage(msg,port){return new Promise((resolve,reject)=>{let sendMsg=(msg,port)=>{_controller.postMessage(msg,port)};if(!_controller)getController().then(controller=>{_controller=controller;sendMsg(msg,port);resolve(true)}).catch(err=>{console.warn(`Cannot send message, controller is not ready yet, ${err.message||err}`);reject(err)});else{sendMsg(msg,port);resolve(true)}})}
initialize();Object.defineProperty(_ref,"isSupported",{"enumerable":true,"configurable":false,"get":_isAvailable?()=>{return true}:_notSupportedHandler});Object.defineProperty(_ref,"initializeNewService",{"enumerable":true,"configurable":false,"writable":false,"value":_isAvailable?initializeNewService:_notSupportedPromise});Object.defineProperty(_ref,"unregisterService",{"enumerable":true,"configurable":false,"writable":false,"value":_isAvailable?unregisterService:_notSupportedPromise});Object.defineProperty(_ref,
"getInstalledService",{"enumerable":true,"configurable":false,"writable":false,"value":_isAvailable?getInstalledService:_notSupportedPromise});Object.defineProperty(_ref,"sendMessage",{"enumerable":true,"configurable":false,"writable":false,"value":_isAvailable?sendMessage:_notSupportedPromise});return _ref}try{Thinfinity!==undefined}catch(e){Thinfinity={}}if(Thinfinity.Service===undefined)Thinfinity.Service={};Thinfinity.Service.Worker=new ServiceWorkerRegistrator;Object.defineProperty(Thinfinity.Service.Worker,
"state",{"enumerable":true,"configurable":false,"get":function(){return _swstate}})})();
(function(){var _ref=this;const _minFiles=Thinfinity?.Files?.Environment?.minFiles||false;var _workerUrl=_minFiles?"thinfinity.svc.wkr.wag.min.js":"thinfinity.service.worker.wag.js";const _swState={READY:0,REJECTED:1,RESOLVED:2};const _swFileState={FAILURE:-1,READY:0,LOADING:1,SUCCESS:2};var _options={scope:"/"};var _proms={};var _tlsRequired=window?.consts?.serviceWorkerTLSRequired||"";var _swInvalidScope=window?.consts?.serviceWorkerInvalidScope||"";var _swInvalidFile=window?.consts?.serviceWorkerInvalidFile||
"";var _swNotSupportedUrl="https://www.cybelesoft.com/support/wvpn-ssl-problem/";var _swAvailable=_swFileState.READY;let _pendingWorkerFileProms=[];let _unregistered=false;function initialize(){updateWorkerUrls();checkServiceWorkerAvailability()}function updateWorkerUrls(){let loc=new URL(location);let akPath=Thinfinity.Service?.akPath??loc.searchParams.get("__akey__")??Thinfinity?.global?.variables?.basePath.replace(/\//g," ").trim().split(" ").join("/")??"/";if(akPath)if(_workerUrl.indexOf(akPath)===
-1)_workerUrl=akPath!=="/"?`${loc.origin}/${akPath}/${_workerUrl}`:`/${_workerUrl}`}function installWorker(url,scope){Thinfinity.Service.Worker.initializeNewService(url,{scope}).then(reg=>{let state="";if(reg.installing){console.warn("Service worker installing");state=Thinfinity.Service.Worker.state.installing}else if(reg.waiting){console.warn("Service worker installed");state=Thinfinity.Service.Worker.state.installed}else if(reg.active){console.warn("Service worker active");state=Thinfinity.Service.Worker.state.activated}_proms[scope]._state=
_swState.RESOLVED;fireEvent(scope,{serviceWorker:state})}).catch(error=>{_proms[scope]._state=_swState.REJECTED;fireEvent(scope,{error,status:_tlsRequired})})}function checkServiceWorkerAvailability(){return new Promise((resolve,reject)=>{const callProms=()=>{let verb=_swAvailable===_swFileState.SUCCESS?"resolve":"reject";_pendingWorkerFileProms.forEach(p=>{try{p[verb]()}catch{}})};const fetchWorkerFile=()=>{_swAvailable=_swFileState.LOADING;if(_workerUrl)fetch(_workerUrl,{type:"HEAD"}).then(result=>
{if(result&&result.status===200){_swAvailable=_swFileState.SUCCESS;resolve(true);callProms()}else{_swStatus=result.statusText;_swAvailable=_swFileState.FAILURE;reject(false);callProms()}}).catch(err=>{console.warn(`Cannot fetch file ${_workerUrl}, ${err.message||err}`);_swStatus=_tlsRequired});else{_swAvailable=_swFileState.FAILURE;_swStatus=_swInvalidFile;reject(_swStatus)}};switch(_swAvailable){case _swFileState.READY:fetchWorkerFile();break;case _swFileState.LOADING:_pendingWorkerFileProms.push({resolve,
reject});break;case _swFileState.SUCCESS:resolve();break;case _swFileState.FAILURE:reject();break}})}function getPromName(state){return state===_swState.RESOLVED?"resolved":state===_swState.REJECTED?"rejected":null}function fireEvent(scope,data){if(_proms[scope]){let state=_proms[scope]._state;let stateName=getPromName(state);_proms[scope].forEach(prom=>{try{switch(state){case _swState.RESOLVED:prom.resolve({...{state,status:stateName},...data});break;case _swState.REJECTED:prom.reject({...{state,
status:stateName},...data});break}}catch(error){}});_proms[scope]=[]}}function checkServiceWorker(scope){if(_proms[scope]._state!==_swState.READY)fireEvent(scope,null);else Thinfinity.Service.Worker.getInstalledService(scope).then(result=>{if(result&&result.active)if(!navigator.serviceWorker.controller&&!_unregistered){_unregistered=true;Thinfinity.Service.Worker.unregisterService(scope,false).then(res=>{checkServiceWorker(scope)}).catch(err=>{console.warn(`Cannot unregister service ${scope} ${err.message||
err} `);checkServiceWorker(scope)})}else{console.warn(`Your ServiceWorker "${scope}" is ${result.active.state}`);_proms[scope]._state=_swState.RESOLVED;fireEvent(scope,{result:result.active})}else installWorker(_workerUrl,scope)}).catch(function(response){installWorker(_workerUrl,scope)})}function normalizeScope(scope){if(scope){let scopes=scope.split("/").filter(s=>s!=="");if(scopes.length==1)return`/${scopes[0]}/`;else return null}else return null}function getDonePromise(scope){return new Promise((resolve,
reject)=>{checkServiceWorkerAvailability().then(()=>{scope=normalizeScope(scope);if(scope){if(!_proms[scope]){_proms[scope]=[];_proms[scope]._state=_swState.READY}_proms[scope].push({resolve,reject});checkServiceWorker(scope)}else reject({messsage:_swInvalidScope})}).catch(reject)})}function isRunning(scope){scope=normalizeScope(scope);if(scope&&_proms[scope])return _proms[scope]._state===_swState.RESOLVED;else return false}initialize();Object.defineProperty(_ref,"done",{"enumerable":true,"configurable":false,
"writable":false,"value":getDonePromise});Object.defineProperty(_ref,"isRunning",{"enumerable":true,"configurable":false,"get":isRunning});Object.defineProperty(_ref,"status",{"enumerable":true,"configurable":false,"get":function(){return _swStatus}});Object.defineProperty(_ref,"supportURL",{"enumerable":true,"configurable":false,"get":function(){return _swNotSupportedUrl}});try{Thinfinity!==undefined}catch(e){Thinfinity={}}if(Thinfinity.Service===undefined)Thinfinity.Service={};Thinfinity.Service.Worker.Initialization=
_ref})();
(function(){function Rule(){var _ref=this;let _rule=null;const _ssKey="__#thinfinity.wag.rules__";var _availableStorages=[];var _forSW=false;try{if(window)_availableStorages=[{storage:window.localStorage,validate:true}]}catch(err){_forSW=true}const _basePath="<%=@BASEURL%>";const _minFiles=Thinfinity?.Files?.Environment?.minFiles||false;let scripts=[];let serverUrl=`${_basePath}`;let injectionsUrl=`${serverUrl}wag/injections/`;let commonLocation=`${serverUrl}common/js/`;let _proxeables={html:true,cookies:true,
history:true,inlineScriptAndStyle:true,inlineElements:true,fetchAndXHR:true,webSocket:true,images:true,htmlParse:true};const getRule=()=>{if(!_rule){let rule=null,idx=0,len=_availableStorages.length;while(!rule&&idx<len){rule=getRuleFrom(_availableStorages[idx]);idx++}if(rule)_rule=rule}if(!_forSW&&_rule)window["__#thinNavigationRules__"]=_rule;return _rule};const setRule=rule=>{if(rule){_rule=rule;addScriptsRules(_rule);let idx=0,len=_availableStorages.length;while(idx<len)try{if(_availableStorages[idx].validate){if(location.pathname.indexOf(rule.path)!==
-1){rule={...rule};let rules=syncRules(_availableStorages[idx],rule);_availableStorages[idx].storage.setItem(_ssKey,JSON.stringify(rules))}}else _availableStorages[idx].storage.setItem(_ssKey,JSON.stringify(rule));idx++}catch(error){}}};const syncRules=(obj,rule)=>{let rules=obj.storage.getItem(_ssKey);if(!rules)rules={};else rules=JSON.parse(rules);rules[rule.path.toLowerCase()]=rule;return rules};const getRuleFrom=obj=>{let rule=null;let data=obj.storage.getItem(_ssKey);if(data)try{rule=JSON.parse(data);
if(obj.validate){let paths=location.pathname.split("/").filter(p=>p!=="");let r=paths.find(p=>rule[`/${p.toLowerCase()}/`]?.path!==undefined);if(r)rule=rule[`/${r.toLowerCase()}/`];else{console.warn(`Cannot find rule for /${p}/ in: ${JSON.stringify(paths)}`);rule=null}}}catch(error){rule=null}return rule};const remove=()=>{let idx=0,len=_availableStorages.length;while(idx<len){_availableStorages[idx].removeItem(_ssKey);idx++}};const addScriptsRules=obj=>{if(_minFiles)scripts=[`${serverUrl}thinfinity.injections.rules.min.js`];
else scripts=[`${commonLocation}thinfinity.identification.js`,`${injectionsUrl}thinfinity.wag.identification.js`,`${injectionsUrl}thinfinity.wag.rule.js`,`${injectionsUrl}thinfinity.jsxss.bundle.js`,`${injectionsUrl}thinfinity.proxy.cookie.js`,`${injectionsUrl}thinfinity.espree.bundle.js`,`${injectionsUrl}thinfinity.wag.utils.js`,`${injectionsUrl}thinfinity.wag.proxies.js`,`${injectionsUrl}thinfinity.proxy.createElement.js`,`${injectionsUrl}thinfinity.wag.ping.js`,`${injectionsUrl}thinfinity.wag.script.js`,
`${injectionsUrl}thinfinity.wag.stylesheet.js`,`${injectionsUrl}thinfinity.wag.xmlhttprequest.js`,`${injectionsUrl}thinfinity.wag.history.js`,`${injectionsUrl}thinfinity.proxy.websocket.js`,`${injectionsUrl}thinfinity.wag.dom.js`];obj.scripts=scripts};const checkUrlSensitive=()=>{let modified=false;let paths=location.pathname.split("/");let rulePath=null;if(!_rule)_rule=getRule();if(_rule){rulePath=_rule.path.split("/").filter(p=>{return p!==""})[0];let found=false,l=paths.length,i=0;while(!found&&
i<l){if(paths[i].toLowerCase()===rulePath.toLowerCase()){if(paths[i]!==rulePath){paths[i]=rulePath;modified=true}found=true}i++}}else{let msg=`Cannot find valid rule, fail to check url sensitive`;console.warn(msg);return false}if(modified){console.warn(`Fixing URL case sensitive`);let nUrl=paths.join("/");location.href=nUrl}else return true};function initialize(){if(!_forSW&&window["__#thinNavigationRules__"])applyRule(window["__#thinNavigationRules__"])}function applyRule(rule){_initializing=false;
_rule=rule;setRule(_rule)}function buildRule(rule,{location,accessKey=null,gateway=null}={}){let newRule=null;if(rule){delete rule.cmd;let serviceWorkerRequired=rule?.sanitizeInput||rule?.forceRoot;rule.serviceWorkerRequired=serviceWorkerRequired;delete rule.profileKey;let oURL=new URL(location.href);let gsr=rule?.getServerUrl??true;let originalGateway=oURL.searchParams.get("__ogateway__");rule.commGateway=!!originalGateway??false;const _nullOrUndef=Symbol();const replacei=(str,rep,rby)=>{let stri=
str;str=str??_nullOrUndef;rep=rep??_nullOrUndef;if([str,rep].indexOf(_nullOrUndef)==-1){var pos=indexOfi(str,rep);return pos==-1?str:str.substr(0,pos)+rby+str.substr(pos+rep.length)}else return stri};const indexOfi=(str,srch)=>{str=str??_nullOrUndef;return str!==_nullOrUndef?str.toLowerCase().indexOf(srch?.toLowerCase()):-1};let originPath=replacei(replacei(rule.url,rule.path,"/"),(new URL(rule.url)).origin+"/","");let originUrlObj;try{originUrlObj=new URL(originPath)}catch(err){originUrlObj=new URL((new URL(rule.url)).origin+
"/"+originPath)}let eData={...{url:location.href,proxy:{origin:location.origin,hostname:location.hostname,host:location.host},baseUrl:{protocol:originUrlObj.protocol,origin:originUrlObj.origin,href:originUrlObj.href,hostname:originUrlObj.hostname,host:originUrlObj.host,pathname:originUrlObj.pathname,search:originUrlObj.search,hash:originUrlObj.hash}},...{proxeables:_proxeables},...rule};let memData={remote:true,isDefault:rule?.isDefault??false,accessKey:(gsr?accessKey:rule?.accessKey)??null,akPath:rule?.akPath??
"/",gateway:gateway,originalGateway:originalGateway};let fData={...eData,...memData};fData={...fData};newRule=fData;setRule(newRule)}return newRule}initialize();Object.defineProperty(_ref,"rule",{enumerable:true,configurable:false,get:getRule,set:setRule});Object.defineProperty(_ref,"remove",{enumerable:true,configurable:false,writable:false,value:remove});Object.defineProperty(_ref,"checkUrlSensitive",{enumerable:true,configurable:false,writable:false,value:checkUrlSensitive});Object.defineProperty(_ref,
"buildRule",{"enumerable":true,"configurable":false,writable:false,value:buildRule});if(_forSW)Object.defineProperty(_ref,"applyRule",{"enumerable":true,"configurable":false,writable:false,value:applyRule})}try{Thinfinity!==undefined}catch(e){Thinfinity={}}if(typeof Thinfinity.WAG==="undefined")Thinfinity.WAG={};Thinfinity.WAG.Rules=new Rule})();const _vdata=Thinfinity?.Service?.variables?.data||null;const _getServerURL=_vdata?.getServerUrl??true;const _GWSID="<%=@GWSID%>";const _basePath="<%=@BASEURL%>";
const _name=Thinfinity.WAG.Identification(_vdata.rule.path.replaceAll("/","")).name;console.warn(`wag: ${_name}`);const _maxRetries=5;let _retriesCount=0;let _sskey="__#thinfinity.wag.activation__";let _activatingList={};let _activating={maxCount:5,count:0,timestamp:null,agent:false,resolving:false,timeout:750};
const showDocumentMessage=(title,msg)=>{document.body.innerHTML="";document.body.style="background-color:#b5b5b5;";let d=document.createElement("div");d.style="min-width:300px;min-height:100px;position:absolute;background-color:#f7f8ff;left:50%;top:50%;transform:translate(-50%,-50%);max-width:600px;border-radius:2px;";let header=document.createElement("div");header.style="width:calc(100% - 10px);height:30px;font-size:14pt;color:#fff;text-align:left;line-height:30px;padding-left:10px;background-color:#3297d6;border-top-left-radius:2px;border-top-right-radius:2px;";
header.innerHTML=title;d.appendChild(header);let bodyElem=document.createElement("div");bodyElem.style="width:calc(100% - 40px);height:auto;font-size:13pt;color:#909090;padding:20px;";bodyElem.innerHTML=msg;d.appendChild(bodyElem);document.body.append(d)};
const showLoadingMessage=()=>{document.body.innerHTML="";document.body.style="background-color:#b5b5b5;";let d=document.createElement("div");d.style="min-width:300px;min-height:100px;position:absolute;background-color:#f7f8ff;left:50%;top:50%;transform:translate(-50%,-50%);max-width:600px;border-radius:2px;";d.style.backgroundImage=`url(${_basePath}images/core/loadajax.gif)`;d.style.backgroundRepeat="no-repeat";d.style.backgroundPosition="center";let span=document.createElement("span");span.style=
"position:absolute;left:50%;top:78%;transform:translate(-50%,-50%);color:#707070;";span.innerHTML="Loading...";d.appendChild(span);document.body.appendChild(d)};
window.onload=function(){var resolve=reject=null;let rule=_vdata?.rule||null;if(!rule){showDocumentMessage("Error",consts.wagInvalidRule);throw new Error(`${consts.wagInvalidRule}`);}showLoadingMessage();let serviceWorkerRequired=rule?.sanitizeInput||rule?.forceRoot;console.warn("SvcWkr is required: "+serviceWorkerRequired);const fixingUrlSensitive=()=>{return new Promise(resolve=>{let paths=window.location.pathname.split("/");let rulePath=rule.path.split("/").filter(p=>{return p!==""});let modified=
false;for(i=0,l=paths.length,l2=rulePath.length,found=false,j=0;i<l&&j<l2;i++){if(paths[i].toLowerCase()===rulePath[j].toLowerCase()){if(paths[i]!==rulePath[j]){paths[i]=rulePath[j];modified=true}found=true}if(found)j++}if(modified){console.warn(`Fixing URL case sensitive`);let nUrl=paths.join("/");location.href=nUrl}else resolve()})};const readStorage=()=>{let actPath=_activating;let ssItem=sessionStorage.getItem(_sskey);if(ssItem&&rule)try{_activatingList=JSON.parse(ssItem);actPath=_activatingList[rule.path];
if(actPath){actPath={..._activating,...actPath};if(Date.now()-actPath.timestamp>45E3)actPath.count=0}}catch(err){actPath.timestamp=Date.now()}else actPath.timestamp=Date.now();_activating=actPath;return _activating};let reloadLocation=()=>{console.warn("Reloading...");if(_activating.resolving)_activating.count++;_activating.timestamp=Date.now();_activatingList[rule.path]=_activating;if(_activating.count>_activating.maxCount){showDocumentMessage("Error",consts.wagActivationFail);sessionStorage.removeItem(_sskey);
throw new Error(consts.wagActivationFail);}else sessionStorage.setItem(_sskey,JSON.stringify(_activatingList));let fUrl=`${rule.path}${rule.resource??""}`;if(fUrl===location.pathname)location.reload();else window.location=fUrl};readStorage();if(_activating.resolving){setTimeout(()=>{reloadLocation()},_activating.timeout);return}if(serviceWorkerRequired){if(!window?.Thinfinity?.Service?.Worker||Thinfinity.Service?.Worker?.isSupported!==true){showDocumentMessage("Error",`[Web WAG] ${Thinfinity.Service?.Worker?.isSupported}`);
return}resolve=()=>{console.warn(`Service worker was initialized correctly!`);reloadLocation()};reject=error=>{console.warn(`Something went wrong.`);showDocumentMessage("Error",`[Web WAG] ${error.status||error}.<br/>If you require any further information, please visit us: <a href="${Thinfinity.Service?.Worker?.Initialization?.supportURL}">here</a>`)}}else{resolve=()=>{reloadLocation()};reject=null}function createURL(url){let nURL=null;try{nURL=new URL(url)}catch(err){let res=`Invalid URL, please check your profile "Web Address" ("<b>${url}</b>")`;
showDocumentMessage("Error",res);throw new Error(res);}return nURL}function registerRules({accessKey=null,gateway=null}={}){return new Promise(resolve=>{let lUrl=createURL(location);let cData={...Thinfinity?.Service?.variables?.data?.rule};let tUrl=createURL(cData.url);cData.url=tUrl.origin+"/";let i=tUrl.pathname.lastIndexOf("/");if(i===-1)tUrl.pathname.length;cData.pathname=tUrl.pathname.substring(0,i+1);if(!cData.pathname.endsWith("/"))cData.pathname+="/";cData.resource=tUrl.pathname.substring(i+
1);let newRule=Thinfinity.WAG.Rules.buildRule(cData,{location,accessKey,gateway});let initMessaging=(port,sendMessage,listen)=>{if(port&&sendMessage){port.onmessage=event=>{if(event?.data?.cmd&&event.data.cmd)switch(event.data.cmd){case "PORT-REGISTERED":sendMessage({...{cmd:"REGISTER-RULE",id:_vdata.rule.path,name:_name},...newRule}).then(r=>{console.warn(`Rule was delivery successful`)}).catch(err=>{console.warn(`Cannot send JSON rule to ServiceWorker ${err}`);location.reload()});console.warn(`Registering Port Message!`);
break;case "RULE-REGISTERED":console.warn(`Rules registration was successful!`);lUrl.search="";resolve(lUrl.href);break;case "DONE":console.warn(`Service Worker Initialized successful!`);lUrl.search="";resolve(lUrl.href);break}};if(listen)sendMessage({cmd:"INIT-PORT",name:_name},[listen]).then(r=>{console.warn(`Port initialization was delivery successful`)}).catch(err=>{console.warn(`Cannot initialize port messaging ${err}`);location.reload()});else sendMessage({cmd:"INIT-PORT",name:_name}).resolve(r=>
{console.warn(`Port initialization was delivery successful`)}).catch(err=>{console.warn(`Cannot initialize port messaging ${err}`);location.reload()})}else throw new Error(`Cannot initialize Worker Message Channel.`);};rule=Thinfinity.WAG.Rules.rule=newRule;if(serviceWorkerRequired){console.warn(`Initializing messaging channel`);let _messageChannel=new MessageChannel;initMessaging(_messageChannel.port2,Thinfinity.Service?.Worker?.sendMessage,_messageChannel.port1)}else{lUrl.search="";resolve(lUrl.href)}})}
const doGetServerURL=vp=>{return new Promise((resolve,reject)=>{const url=`${typeof vp==="string"&&vp.length>0?`/${vp}/`:"/"}getServerUrl`;return fetch(url,{"referrerPolicy":"same-origin","body":null,"method":"GET","mode":"cors","credentials":"include"}).then(res=>{if(res.status===200)try{resolve(res.json())}catch(err){reject(err)}else reject(res.statusText||`Something went wrong, cannot get resource (${res.status})`)})})};const tryServerURL=(virtualPath,success,fail)=>{doGetServerURL(virtualPath).then(res=>
{if(res.errmsg)fail.call(this,res.errmsg);else if(res&&res.redirect&&res.poolid)success.call(this,res);else tryServerURL(virtualPath,success,fail)}).catch(err=>{_retriesCount++;if(_retriesCount<_maxRetries)tryServerURL(virtualPath,success,fail);else fail.call(this,err)})};const resolveServerUrl=virtualPath=>{_retriesCount=0;return new Promise((resolve,reject)=>{tryServerURL(virtualPath,res=>{if(res.gateway)res.gateway=res.gateway.endsWith("/")?res.gateway.substr(0,res.gateway.length-1):res.gateway;
res={...res,redirectUrl:`${res.gateway?res.gateway:""}/${res.poolid}/${virtualPath}/`,gateway:res.gateway??null};resolve(res)},reject)})};const getServerUrl=()=>{if(_getServerURL){const vpath=location.pathname.replaceAll("/","");_activating.resolving=true;resolveServerUrl(vpath).then(res=>{let gsuRules={accessKey:res.poolid,gateway:res.gateway};let gatewayUrl=null;if(res.redirectUrl!=location.pathname)if(res.gateway){gatewayUrl=createURL(res.gateway);gatewayUrl.pathname+=(!gatewayUrl.pathname.endsWith("/")?
"/":"")+`${vpath}/`;gatewayUrl.search=`?__ogateway__=${location.href.replace(/http:|https:/igm,"")}&_gwsid=${_GWSID}&__akey__=${res.poolid}`}console.warn(`Registering rules..., please wait`);registerRules(gsuRules,gatewayUrl?.href??null).then(()=>{console.warn(`Rule registration was successful!`);resolve()})}).catch(err=>{let msg=err.message||err;console.log("error: ",msg);showDocumentMessage("Something went wrong",msg)})}else showDocumentMessage("Something went wrong","Something went wrong, cannot initialize Thinfinity.WAG, serverUrl is null or undefined and Service Worker is required.")};
fixingUrlSensitive().then(()=>{setTimeout(()=>{if(serviceWorkerRequired)Thinfinity.Service?.Worker?.Initialization?.done(_vdata.rule.path).then(getServerUrl).catch(reject);else if(Thinfinity.Service?.Worker?.unregisterService)Thinfinity.Service.Worker.unregisterService(_vdata.rule.path,false).then(getServerUrl).catch(reject);else getServerUrl()},1E3)})};
